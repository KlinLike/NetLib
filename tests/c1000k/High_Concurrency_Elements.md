在Linux中，要建立超过100万个连接，有三个要素是非常关键的：
1. 突破四元组的限制
2. 解除系统资源瓶颈
3. 采用高性能I/O模型

## 如何突破四元组限制
假设只有一台服务器和一台客户端，四元组中的两个 IP 就被固定了，只能在 `Port` 上面进行变化（也有 IP 上变化的方法，这里不讨论）。
又因为 `Port` 是一个 16bit 无符号整数，所以理论上如果只有一个 `Port` 可变，最多只能建立 `2^16 = 65536` 个连接。但现实是两个 `Port` 都能变，只需要服务器多开一些端口。`6W * 20 ≈ 120W`，所以只需要服务器能有 20 个不同的端口，就能建立超过 100 万个连接。

总而言之，第一个突破四元组限制的方法，就是服务器要多开一些端口。

## 解除系统资源瓶颈
需要处理的瓶颈有：
1. 文件描述符限制，默认值可能是1024或者4096，是一个进程所能打开的文件描述符的上限，超过上限会无法打开。显然我们需要修改这个限制，否则还需要多个进程才能实现百万并发，增加开发难度。

要注意的点：
- 文件描述符的限制是多重筛子，有进程级别的资源限制和系统级别的资源限制，还需要保证配置会被加载。
- 调整全连接和半连接队列的长度，降低连接被拒绝的概率。
- 修改 TCP 状态机的变化时间，连接断开后，TCP 连接会停留在 `TIME_WAIT` 状态一段时间，此时占用内存且无法被复用。缩短这个时间和允许 `TIME_WAIT` 状态的连接（也可以理解为四元组）复用，对提高连接利用率很有帮助。

2. 内存限制，每个连接都需要占用一些内存，主要是用作缓冲区。如果服务器or客户端的内存有限，就需要考虑适当调小缓冲区的大小。

3. 动态端口范围限制，默认情况下，Linux会限制动态端口的范围在32768到61000之间。如果需要建立的连接数超过这个范围，就需要修改这个限制。

> 所有这些配置，都可以在项目中通过 `setup_100w.sh` 脚本来检查和设置。

## 采用高性能 I/O 模型
这里我们使用了 `EPOLL`，能够满足要求。
